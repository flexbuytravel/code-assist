rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // AUTHENTICATION REQUIREMENTS
    // ==============================
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.role == 'admin';
    }

    function isCompany() {
      return isSignedIn() && request.auth.token.role == 'company';
    }

    function isAgent() {
      return isSignedIn() && request.auth.token.role == 'agent';
    }

    function isCustomer(customerId) {
      return isSignedIn() && request.auth.uid == customerId;
    }

    // Allow admins full read/write access
    match /companies/{companyId} {
      allow read, write: if isAdmin();
    }

    // Company manages its agents
    match /companies/{companyId}/agents/{agentId} {
      allow read: if isCompany() && request.auth.uid == companyId;
      allow write: if isCompany() && request.auth.uid == companyId;
    }

    // Agents can create packages for their company
    match /companies/{companyId}/packages/{packageId} {
      allow read: if isSignedIn();
      allow write: if isAgent();
    }

    // ==============================
    // CUSTOMER DATA
    // ==============================
    match /customers/{customerId} {
      // Customers can read their own record
      allow read: if isCustomer(customerId);

      // Customers can update their own profile â€” but not payment fields
      allow update: if isCustomer(customerId) &&
        !( 'paymentStatus' in request.resource.data ||
           'trips' in request.resource.data ||
           'expirationDate' in request.resource.data ||
           'lastPaymentDate' in request.resource.data );

      // Stripe webhook or backend service account updates payment-related fields
      allow update: if request.auth.token.firebase.sign_in_provider == "custom" &&
        request.auth.token.role == 'server';

      // Admins can still manage everything if needed
      allow write: if isAdmin();
    }

  }
}